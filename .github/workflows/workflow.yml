name: Wiktionary IPA Extractor

on:
  # Manual trigger via the GitHub Actions tab
  workflow_dispatch:
  
  # Trigger the build and release of binaries only when Go code changes
  push:
    paths:
      - '**/*.go'  # Trigger when any Go code changes
  
  # Trigger the nightly data ingestion job to check the RSS feed and process the data
  schedule:
    - cron: '0 0 * * *'  # Run nightly

permissions:
  packages: write
  contents: write

jobs:
  # Job for building binaries (Mac and Linux) and attaching them to the release when Go code changes
  build-and-release-binaries:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out the repository
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Set up Docker container with Golang installed
      - name: Set up Docker
        run: |
          docker pull golang:latest

      # Step 3: Build Linux binary
      - name: Build Linux binary
        run: |
          docker run --name go-build-linux -v ${{ github.workspace }}:/workspace -w /workspace golang:latest /bin/bash -c "go build -o ./wiktionary-ipa-extract-linux cmd/wiktionary-ipa-extract/main.go"

      # Step 4: Build Mac binary
      - name: Build Mac binary
        run: |
          docker run --name go-build-mac -v ${{ github.workspace }}:/workspace -w /workspace golang:latest /bin/bash -c "GOOS=darwin GOARCH=arm64 go build -o ./wiktionary-ipa-extract-mac cmd/wiktionary-ipa-extract/main.go"

      # Step 5: Create GitHub Release (without requiring tags)
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: "auto-release-${{ github.sha }}"  # Automatically generated tag
          name: "Wiktionary IPA Extract Release - ${{ github.sha }}"
          body: "Automated release for commit ${{ github.sha }}"
          draft: false
          prerelease: false
          artifacts: |
            ./wiktionary-ipa-extract-linux
            ./wiktionary-ipa-extract-mac

  # Job for processing the Wiktionary data based on the RSS feed using the binary
  process-data:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out the repository
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Fetch RSS and check timestamp
      - name: Fetch RSS and check timestamp
        id: check_dump
        run: |
          # Check if last_run_timestamp.txt exists, if not initialize it
          if [ ! -f last_run_timestamp.txt ]; then
            echo "none" > last_run_timestamp.txt
          fi

          # Get the latest dump date from the RSS feed
          latest_dump_date=$(curl -s https://dumps.wikimedia.org/enwiktionary/latest/enwiktionary-latest-pages-articles.xml.bz2-rss.xml | grep -oP '(?<=<pubDate>).*?(?=</pubDate>)')

          # Read the last run date from the file
          last_run_date=$(cat last_run_timestamp.txt)

          # Compare dates and proceed if the latest dump is new
          if [ "$last_run_date" != "$latest_dump_date" ]; then
            echo "New dump found, proceeding with extraction."
            echo "$latest_dump_date" > last_run_timestamp.txt
            echo "LATEST_DUMP_DATE=$latest_dump_date" >> $GITHUB_ENV  # Use environment file instead of set-output
          else
            echo "No new dump available, exiting."
            exit 0

      # Step 3: Sanitize the dump date for use in tags and file names
      - name: Sanitize and set release tag
        id: sanitize_tag
        run: |
          sanitized_date=$(echo "${{ env.LATEST_DUMP_DATE }}" | sed 's/[: ]/-/g')
          echo "RELEASE_TAG=auto-release-$sanitized_date" >> $GITHUB_ENV
          echo "SANITIZED_DATE=$sanitized_date" >> $GITHUB_ENV

      # Step 4: Check and build the binary if necessary
      - name: Check and build binary if necessary
        run: |
          if [ ! -f ./wiktionary-ipa-extract ]; then
            docker pull golang:latest
            docker run --name go-build-linux -v ${{ github.workspace }}:/workspace -w /workspace golang:latest /bin/bash -c "go build -o wiktionary-ipa-extract cmd/wiktionary-ipa-extract/main.go"
          fi

      # Step 5: Process the latest data dump using the binary
      - name: Process Wiktionary Dump
        run: |
          curl https://dumps.wikimedia.org/enwiktionary/latest/enwiktionary-latest-pages-articles.xml.bz2 | ./wiktionary-ipa-extract --bz -o enwiktionary-latest-pages-articles-${{ env.SANITIZED_DATE }}.jsonl

      # Step 6: Gzip the JSONL file
      - name: Gzip the JSONL file
        run: |
          gzip -9 enwiktionary-latest-pages-articles-${{ env.SANITIZED_DATE }}.jsonl

      # Step 7: Create Release for processed JSONL file
      - name: Release Processed JSONL File
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.RELEASE_TAG }}  # Use the sanitized tag
          name: "Wiktionary Data Processed - ${{ env.RELEASE_TAG }}"
          body: "Automated data release for dump ${{ env.RELEASE_TAG }}"
          draft: false
          prerelease: false
          artifacts: |
            enwiktionary-latest-pages-articles-${{ env.SANITIZED_DATE }}.jsonl.gz
